#!/bin/bash -u

# get canonical source name
src_name=$(readlink -f ${BASH_SOURCE[0]})

# get source path
## physical (canonical)
src_dir_phys=$(dirname "$src_name")
## logical (links)
src_dir_logi=$(dirname "$BASH_SOURCE")

# determine if script is being sourced or executed and add conditional behavior
if (return 0 2>/dev/null); then
    RUN_TYPE="sourcing"
else
    RUN_TYPE="executing"
    # exit on errors
    set -e
fi

# check if running interactively
if [[ "$-" == *i* ]]; then
    # print run type and source name
    echo -e "${TAB}${RUN_TYPE} ${PSDIR}$BASH_SOURCE${NORMAL}..."
    if [ ! "$BASH_SOURCE" = "$src_name" ]; then
        echo -e "${TAB}${VALID}link${NORMAL} -> $src_name"
    fi
    # print source path
    ## physical
    echo -e "${TAB}${gray}phys -> $src_dir_phys${NORMAL}"
    ## logical
    echo -e "${TAB}${gray}logi -> $src_dir_logi${NORMAL}"
fi

# load bash utils
for util in lib_colors.sh lib_cond_echo.sh lib_fmt.sh lib_links.sh lib_tabs.sh lib_traps.sh; do
    # use the canonical (physical) source directory for reference; this is important if sourcing
    # this file directly from shell
    fname="${src_dir_phys}/${util}"
    if [ -e "${fname}" ]; then
        source ${fname}
    else
        echo "${fname} not found"
    fi
done

# set debug level
declare -i DEBUG=${DEBUG:=0} # default value if DEBUG is unset or null
decho "DEBUG = $DEBUG"

# If not running interactively, reduce prints
if [[ "$-" == *i* ]]; then
    itab
    msg=$(echo "this file is ${src_name##*/}!")
    ln=$(for ((i = 1; i <= ${#msg}; i++)); do echo -n "-"; done)
    echo -e "$ln\n$msg\n$ln" | sed "s/^/${TAB}/"
    # add read-only variable to check if this file has already been loaded
    if [ -z ${FPRETTY_LOADED+dummy} ]; then
        declare -grx FPRETTY_LOADED=true
    else
        echo -e "${TAB}${yellow}${BASH_SOURCE[0]##*/} already loaded${NORMAL}"
    fi
    dtab
fi
