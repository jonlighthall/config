# Set DISPLAY for WSL2
# Note: this file must use unix line endings (LF)!
if [ -z $VB ]; then
    export VB=false
else
    if $VB; then
	# set tab
	fTAB="   "
	TAB+=$fTAB
	# print source name at start
	echo -n "${TAB}running $BASH_SOURCE"
	src_name=$(readlink -f $BASH_SOURCE)
	if [ ! "$BASH_SOURCE" = "$src_name" ]; then
	    echo -n " -> $src_name"
	fi
	echo "..."
	# source formatting
	fpretty=${HOME}/utils/bash/.bashrc_pretty
	if [ -e $fpretty ]; then
	    source $fpretty
	fi
    fi
fi
# one of the following asignments should work
if [ $HOSTNAME = "DTWUSC001" ]; then
    export DISPLAY=localhost:0.0
else
    IDX=1
    #export DISPLAY=$(\grep nameserver /etc/resolv.conf | sed -n ''"${IDX}"' p' | awk '{print $2}'):0.0
    export DISPLAY=$(route.exe print | \grep 0.0.0.0 | sed -n ''"${IDX}"' p' | awk '{print $4}'):0.0 # works on lappy
fi

# X Window
if [ -z "${DISPLAY}" ]; then
    export DISPLAY=localhost:0.0
    if $VB; then
	echo "${TAB}setting DISPLAY to $DISPLAY"
    fi
else
    if $VB; then
	echo "${TAB}DISPLAY set to $DISPLAY"
    fi
fi

alias xming='/mnt/c/Program\ Files\ \(x86\)/Xming/Xming.exe >/dev/null 2>&1 :0 -clipboard -multiwindow -silent-dup-error -logverbose 0 &'
alias vcx='/mnt/c/Program\ Files/VcXsrv/vcxsrv.exe >/dev/null 2>&1 :0 -ac -clipboard -multiwindow -silent-dup-error &'

# Check if xwin is running
# -x flag only match processes whose name (or command line if -f is
# specified) exactly match the pattern.

PROG="vcxsrv.exe"
if pgrep -x $PROG >/dev/null
then
    if $VB; then
	echo "${TAB}$PROG is already running"
    fi
    TAB=${TAB::-${#fTAB}}
    return 0
else
    DIR=/mnt/c/Program\ Files/VcXsrv
    if [ -d "$DIR" ]; then
	if $VB; then
	    echo -e "${TAB}found $DIR"
	fi
	if [ -f "$DIR/$PROG" ]; then
	    if $VB; then
		echo -e "${TAB}Launching $PROG...\c"
	    fi
	    (vcx)
	    if [[ $? == 0 ]]; then
		if $VB; then
		    echo -e "${GOOD}OK${NORMAL}"
		fi
		TAB=${TAB::-${#fTAB}}
		return 0
	    else
		if $VB; then
		    echo -e "${BAD}FAIL${NORMAL}"
		    echo "${TAB}unaliasing $PROG..."
		fi
		unalias vcx 2>/dev/null
	    fi
	else
	    if $VB; then
		echo -e "${TAB}$PROG ${UL}not found${NORMAL}"
		echo "${TAB}unaliasing $PROG..."
	    fi
	    unalias vcx 2>/dev/null
	fi
    else
	if $VB; then
	    echo -e "${TAB}$DIR ${UL}not found${NORMAL}"
	    echo "${TAB}unaliasing $PROG..."
	fi
	unalias vcx 2>/dev/null
    fi
fi

PROG="Xming.exe"
if pgrep -x $PROG >/dev/null
then
    if $VB; then
	echo "${TAB}$PROG is already running"
    fi
    TAB=${TAB::-${#fTAB}}
    return 0
else
    DIR=/mnt/c/Program\ Files\ \(x86\)/Xming
    if [ -d "$DIR" ]; then
	if $VB; then
	    echo -e "${TAB}found $DIR"
	fi
	if [ -f "$DIR/$PROG" ]; then
	    if $VB; then
		echo -e "${TAB}Launching $PROG...\c"
	    fi
	    (xming)
	    if [[ $? == 0 ]]; then
		if $VB; then
		    echo -e "${GOOD}OK${NORMAL}"
		fi
		TAB=${TAB::-${#fTAB}}
		return 0
	    else
		if $VB; then
		    echo -e "${BAD}FAIL${NORMAL}"
		    echo "${TAB}unaliasing $PROG..."
		fi
		unalias xming 2>/dev/null
	    fi
	else
	    if $VB; then
		echo -e "${TAB}$PROG ${UL}not found${NORMAL}"
		echo "${TAB}unaliasing $PROG..."
	    fi
	    unalias xming 2>/dev/null
	fi
    else
	if $VB; then
	    echo -e "${TAB}$DIR ${UL}not found${NORMAL}"
	    echo "${TAB}unaliasing $PROG..."
	fi
	unalias xming 2>/dev/null
    fi
fi
TAB=${TAB#$fTAB}
