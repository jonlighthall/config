# Set DISPLAY for WSL2
# Note: this file must use unix line endings (LF)! 
if [ -z $VB ]; then
    export VB=false
else
    if $VB; then
	echo "running $BASH_SOURCE..."
	GOOD='\033[0;32m'
	BAD='\033[0;31m'
	NORMAL='\033[0m'
    fi
fi
# one of the following asignments should work
if [ $HOSTNAME = "DTWUSC001" ]; then
    export DISPLAY=localhost:0.0
else
    #export DISPLAY=$(grep nameserver /etc/resolv.conf | awk '{print $2}'):0.0
    export DISPLAY=$(route.exe print | grep 0.0.0.0 | head -1 | awk '{print $4}'):0.0 # works on lappy   
fi

# X Window
if [ -z "${DISPLAY}" ]; then
    export DISPLAY=localhost:0.0
    if $VB; then
	echo "setting DISPLAY to $DISPLAY"
    fi
else
    if $VB; then
	echo "DISPLAY set to $DISPLAY"
    fi
fi

alias xming='/mnt/c/Program\ Files\ \(x86\)/Xming/Xming.exe >/dev/null 2>&1 :0 -clipboard -multiwindow -silent-dup-error -logverbose 0 &'
alias vcx='/mnt/c/Program\ Files/VcXsrv/vcxsrv.exe >/dev/null 2>&1 :0 -ac -clipboard -multiwindow -silent-dup-error &'

# Check if xwin is running
# -x flag only match processes whose name (or command line if -f is
# specified) exactly match the pattern. 

PROG="vcxsrv.exe"
if pgrep -x $PROG >/dev/null
then
    if [ -z $VB ]; then
	echo "$PROG is already running"
    fi
    return 0
else
    DIR=/mnt/c/Program\ Files/VcXsrv
    if [ -d "$DIR" ]; then
	if [ -f "$DIR/$PROG" ]; then
	    if [ -z $VB ]; then
		echo -e "Launching $PROG...\c"
	    fi
	    (vcx)
	    if [[ $? == 0 ]]; then
		if [ -z $VB ]; then
		    echo -e "${GOOD}OK${NORMAL}"
		fi
		return 0
	    else
		if [ -z $VB ]; then
		    echo "failed"
		    echo -e "${BAD}FAIL${NORMAL}"
		fi
		unalias vcx 2>/dev/null
	    fi
	else
	    if [ -z $VB ]; then
		echo "$PROG not found"
	    fi
	    unalias vcx 2>/dev/null
	fi
    else	
	if [ -z $VB ]; then
	    echo "$DIR not found"
	fi
	unalias vcx 2>/dev/null
    fi
fi

PROG="Xming.exe"
if pgrep -x $PROG >/dev/null
then
    if [ -z $VB ]; then
	echo "$PROG is already running"
    fi
    return 0   
else
    DIR=/mnt/c/Program\ Files\ \(x86\)/Xming
    if [ -d "$DIR" ]; then
	if [ -f "$DIR/$PROG" ]; then
	    if [ -z $VB ]; then
		echo -e "Launching $PROG...\c"
	    fi
	    (xming)
	    if [[ $? == 0 ]]; then
		if [ -z $VB ]; then
		    echo -e "${GOOD}OK${NORMAL}"
		fi
		return 0   
	    else
		if [ -z $VB ]; then
		    echo -e "${BAD}FAIL${NORMAL}"
		fi
		unalias xming 2>/dev/null
	    fi
	else
	    if [ -z $VB ]; then
		echo "$PROG not found"
	    fi
	    unalias xming 2>/dev/null
	fi
    else
	if [ -z $VB ]; then
	    echo "$DIR not found"
	fi
	unalias xming 2>/dev/null
    fi
fi
