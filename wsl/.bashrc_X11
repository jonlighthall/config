# Set DISPLAY for WSL2
# Note: this file must use unix line endings (CF)! 
if [ -z $VB ]; then
    export VB=false
else
    if $VB; then
	echo "running $BASH_SOURCE..."
	GOOD='\033[0;32m'
	BAD='\033[0;31m'
	NORMAL='\033[0m'
    else
	echo "VB = $VB"
    fi
fi
# one of the following asignments should work
if [ $HOSTNAME = "DTWUSC001" ]; then
    export DISPLAY=localhost:0.0
else
    #export DISPLAY=$(grep nameserver /etc/resolv.conf | awk '{print $2}'):0.0
    export DISPLAY=$(route.exe print | grep 0.0.0.0 | head -1 | awk '{print $4}'):0.0 # works on lappy   
fi

# X Window
if [ -z "${DISPLAY}" ]; then
    export DISPLAY=localhost:0.0
    echo "setting DISPLAY to $DISPLAY"
else
    echo "DISPLAY set to $DISPLAY"
fi

alias xming='/mnt/c/Program\ Files\ \(x86\)/Xming/Xming.exe >/dev/null 2>&1 :0 -clipboard -multiwindow -silent-dup-error -logverbose 0 &'
alias vcx='/mnt/c/Program\ Files/VcXsrv/vcxsrv.exe >/dev/null 2>&1 :0 -ac -clipboard -multiwindow -silent-dup-error &'

# Check if xwin is running
# -x flag only match processes whose name (or command line if -f is
# specified) exactly match the pattern. 

PROG="vcxsrv.exe"
if pgrep -x $PROG >/dev/null
then
    echo "$PROG is already running"
    return 0
else
    DIR=/mnt/c/Program\ Files/VcXsrv
    if [ -d "$DIR" ]; then
	if [ -f "$DIR/$PROG" ]; then
	    echo -e "Launching $PROG...\c"
	    (vcx)
	    if [[ $? == 0 ]]; then
		echo -e "${GOOD}OK${NORMAL}"
		return 0
	    else
		echo "failed"
		echo -e "${BAD}FAIL${NORMAL}"
		unalias vcx 2>/dev/null
	    fi
	else	
	    echo "$PROG not found"
	    unalias vcx 2>/dev/null
	fi
    else	
	#    	echo "$DIR not found"
	unalias vcx 2>/dev/null
    fi
fi

PROG="Xming.exe"
if pgrep -x $PROG >/dev/null
then
    echo "$PROG is already running"
    return 0   
else
    DIR=/mnt/c/Program\ Files\ \(x86\)/Xming
    if [ -d "$DIR" ]; then
	if [ -f "$DIR/$PROG" ]; then
	    echo -e "Launching $PROG...\c"
	    (xming)
	    if [[ $? == 0 ]]; then
		echo -e "${GOOD}OK${NORMAL}"
		return 0   
	    else
		echo -e "${BAD}FAIL${NORMAL}"
		unalias xming 2>/dev/null
	    fi
	else	
	    echo "$PROG not found"
	    unalias xming 2>/dev/null
	fi
    else	
	#	echo "$DIR not found"
	unalias xming 2>/dev/null
    fi
fi
